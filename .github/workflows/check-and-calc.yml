name: Check And Calculate PKG_MIRROR_HASH

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target OpenWrt version. if empty the simple mode will be used.'
        required: false
        type: string
  push:
    branches:
      - "main"
    paths:
      - "Makefile"

permissions:
  contents: write

jobs:
  check_and_calc:
    name: Check upstream and calculate PKG_MIRROR_HASH
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check.outputs.updated }}
      new_ver: ${{ steps.check.outputs.new_ver }}
      new_hash: ${{ steps.calc.outputs.NEW_HASH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ” Check for updates
        id: check
        run: |
          set -euo pipefail

          UPSTREAM_URL="https://github.com/tfslabs/vlmcsd.git"
          API_URL="https://api.github.com/repos/tfslabs/vlmcsd/commits"

          CURRENT_VER=$(grep '^PKG_SOURCE_VERSION:=' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')

          REMOTE_VER=$(git ls-remote $UPSTREAM_URL HEAD | awk '{print $1}')

          echo "Current: $CURRENT_VER"
          echo "Remote:  $REMOTE_VER"

          if [ -z "$REMOTE_VER" ]; then
            echo "âŒ Failed to get remote version."
            exit 1
          fi

          if [ "$CURRENT_VER" = "$REMOTE_VER" ]; then
            echo "âœ… Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸš€ New version found! Updating..."

          COMMIT_JSON=$(curl -s "${API_URL}/${REMOTE_VER}")
          NEW_DATE=$(echo "$COMMIT_JSON" | jq -r '.commit.committer.date' | cut -d'T' -f1)

          if [ -z "$NEW_DATE" ] || [ "$NEW_DATE" = "null" ]; then
             NEW_DATE=$(date +%Y-%m-%d)
          fi

          sed -i "s|^PKG_SOURCE_VERSION:=.*|PKG_SOURCE_VERSION:=$REMOTE_VER|" Makefile
          sed -i "s|^PKG_SOURCE_DATE:=.*|PKG_SOURCE_DATE:=$NEW_DATE|" Makefile

          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_ver=$REMOTE_VER" >> $GITHUB_OUTPUT

      - name: Calculate PKG_MIRROR_HASH (replicated old method)
        id: calc
        if: steps.check.outputs.updated == 'true'
        shell: bash
        env:
          TARGET_VERSION: '24.10.4'
          MAKEFILE: Makefile
        run: |
          set -euo pipefail

          BASE_URL="https://downloads.openwrt.org/releases/${TARGET_VERSION}/targets/x86/64"
          echo "BASE_URL=${BASE_URL}" >> $GITHUB_ENV

          PKG_NAME=$(grep -E '^PKG_NAME[:?]?=' "${MAKEFILE}" | head -n1 | sed -E 's/PKG_NAME[:?]?= *//' || true)
          if [ -z "$PKG_NAME" ]; then
            echo "PKG_NAME not found in ${MAKEFILE}" >&2
            exit 1
          fi
          echo "PKG_NAME=${PKG_NAME}"

          wget -q "${BASE_URL}/sha256sums" -O sha256sums
          SDK_FILE=$(grep "openwrt-sdk" sha256sums | awk '{print $2}' | sed 's/^\*//')
          SDK_HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          if [ -z "$SDK_FILE" ] || [ -z "$SDK_HASH" ]; then
            echo "Failed to parse sha256sums for sdk" >&2
            cat sha256sums
            exit 1
          fi
          echo "SDK_FILE=${SDK_FILE}"
          echo "SDK_HASH=${SDK_HASH}"

          SDK_DIR="openwrt-sdk"
          if [ -d "$SDK_DIR" ]; then
            echo "Using existing $SDK_DIR directory"
          else
            wget -q "${BASE_URL}/${SDK_FILE}" -O "${SDK_FILE}"
            echo "${SDK_HASH}  ${SDK_FILE}" | sha256sum -c - || { echo "sdk sha256 mismatch"; exit 1; }
            if echo "${SDK_FILE}" | grep -qE '\.tar\.zst$'; then
              tar -I zstd -xf "${SDK_FILE}"
            else
              tar -xf "${SDK_FILE}"
            fi
            SDK_EXTRACT_DIR=$(tar -tf "${SDK_FILE}" | awk -F/ 'NR==1 {print $1; exit}')
            mv "${SDK_EXTRACT_DIR}" "${SDK_DIR}"
            rm -f "${SDK_FILE}"
          fi

          rm -rf "${SDK_DIR}/package/custom/${PKG_NAME}"
          mkdir -p "${SDK_DIR}/package/custom/${PKG_NAME}"
          rsync -a . "${SDK_DIR}/package/custom/${PKG_NAME}/" \
            --exclude "${SDK_DIR}" --exclude '.git' --exclude '.github' --exclude 'TOPDIR' --exclude 'openwrt-sdk' || true

          pushd "${SDK_DIR}"

          rm -f dl/${PKG_NAME}-*.tar.* || true
          rm -rf build_dir/*/${PKG_NAME}* || true

          make defconfig
          echo "Running make package/custom/${PKG_NAME}/download PKG_MIRROR_HASH=skip"
          make package/custom/${PKG_NAME}/download PKG_MIRROR_HASH=skip V=s

          DOWNLOADED_FILE=$(find dl -type f -name "${PKG_NAME}*" | head -n 1 || true)
          if [ -z "$DOWNLOADED_FILE" ]; then
            echo "âŒ Error: No file found in ${SDK_DIR}/dl/ after download"
            echo "Listing dl/"
            ls -la dl || true
            popd
            exit 1
          fi
          echo "Found downloaded file: $DOWNLOADED_FILE"

          NEW_HASH=$(sha256sum "$DOWNLOADED_FILE" | awk '{print $1}')
          echo "Calculated NEW_HASH=${NEW_HASH}"
          echo "NEW_HASH=${NEW_HASH}" >> $GITHUB_OUTPUT

          popd
          sed -i "s|^PKG_MIRROR_HASH.*|PKG_MIRROR_HASH:=${NEW_HASH}|" "${MAKEFILE}" || true

          echo "PKG_MIRROR_HASH=${NEW_HASH}" >> $GITHUB_ENV

      - name: Commit Makefile locally (no push)
        if: steps.calc.outputs.NEW_HASH != ''
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "onenas-bot"
          git config user.email "onenas-bot@example.com"

          git add -f Makefile

          if git diff --staged --quiet; then
            echo "No staged changes to commit for Makefile."
          else
            git commit -m "Update-PKG_MIRROR_HASH to ${{ steps.calc.outputs.NEW_HASH }}" || true
            echo "Committed updated Makefile locally (no push)."
          fi
          
      - name: Show calculated values
        if: steps.check.outputs.updated == 'true'
        run: |
          echo "new_ver = ${{ steps.check.outputs.new_ver }}"
          echo "NEW_HASH = ${{ steps.calc.outputs.NEW_HASH }}"
