name: Calculate PKG_MIRROR_HASH

on:
  workflow_dispatch:
  push:
    paths:
      - 'Makefile'
jobs:
  calculate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üßæ Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üìõ Extract PKG_NAME
        run: |
          PKG_NAME=$(grep -E '^PKG_NAME[:?]?=' Makefile | head -n1 | sed -E 's/PKG_NAME[:?]?= *//')
          echo "PKG_NAME=$PKG_NAME" >> "$GITHUB_ENV"

      - name: üì• Download sha256sums
        run: |
          BASE_URL="https://downloads.openwrt.org/releases/24.10.4/targets/x86/64"
          wget -q ${BASE_URL}/sha256sums
          echo "BASE_URL=$BASE_URL" >> "$GITHUB_ENV"

      - name: üîë Extract SDK hash
        id: sdk-hash
        run: |
          HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: ‚ôªÔ∏è Cache OpenWrt SDK
        id: cache
        uses: actions/cache@v4
        with:
          path: openwrt-sdk
          key: sdk-${{ runner.os }}-${{ steps.sdk-hash.outputs.hash }}

      - name: üì¶ Download & Extract OpenWrt SDK
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          SDK_FILE=$(grep "openwrt-sdk" sha256sums | awk '{print $2}' | sed 's/^\*//')
          SDK_HASH=$(grep "openwrt-sdk" sha256sums | awk '{print $1}')
          echo "Downloading SDK: $SDK_FILE"
          wget -q ${BASE_URL}/${SDK_FILE}
          echo "${SDK_HASH}  ${SDK_FILE}" | sha256sum -c -
          tar -I zstd -xf ${SDK_FILE}
          SDK_DIR=$(tar -tf ${SDK_FILE} | awk -F/ 'NR==1 {print $1; exit}')
          mv "$SDK_DIR" openwrt-sdk

      - name: üîó Link package into SDK
        run: |
          mkdir -p openwrt-sdk/package/custom/${PKG_NAME}
          rsync -a ./ openwrt-sdk/package/custom/${PKG_NAME}/ \
            --exclude 'openwrt-sdk' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'LICENSE' \
            --exclude 'README.md' \
            --exclude 'SECURITY.md'

      - name: üîç Run check to calculate hash
        run: |
          cd openwrt-sdk
          make defconfig
          rm -f dl/${PKG_NAME}-*.tar.*
          rm -rf build_dir/*/${PKG_NAME}*
          make package/custom/${PKG_NAME}/download V=s
          (make package/custom/${PKG_NAME}/check V=s || true) | tee ../check.log
          touch ../check.log

      - name: üßÆ Compute build fingerprint (ignore PKG_MIRROR_HASH)
        id: fp
        run: |
          # Makefile without PKG_MIRROR_HASH line
          grep -v '^PKG_MIRROR_HASH' Makefile > .Makefile.nohash
          # Hash of Makefile (no hash line) + patches directory (if exists)
          if [ -d patches ]; then
            find patches -type f -print0 | sort -z | xargs -0 sha256sum > .patches.sha
          else
            : > .patches.sha
          fi
          cat .Makefile.nohash .patches.sha | sha256sum | awk '{print $1}' > .fingerprint
          FP=$(cat .fingerprint)
          echo "fingerprint=$FP" >> $GITHUB_OUTPUT
          echo "Computed fingerprint: $FP"

      - name: üìù Update PKG_MIRROR_HASH if needed
        run: |
          NEW_HASH=$(grep -Eo '[0-9a-f]{64}' check.log | tail -n1)
          OLD_HASH=$(grep '^PKG_MIRROR_HASH' Makefile | awk -F= '{print $2}')
          if [ -z "$NEW_HASH" ]; then
            echo "‚ùå Failed to extract PKG_MIRROR_HASH from check.log"
            echo "---- check.log ----"; cat check.log; echo "-------------------"
            exit 1
          fi
          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "‚ÑπÔ∏è Hash unchanged ($NEW_HASH), no commit."
            exit 0
          fi
          sed -i "s|^PKG_MIRROR_HASH.*|PKG_MIRROR_HASH:=$NEW_HASH|" Makefile
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "Update PKG_MIRROR_HASH FP=${{ steps.fp.outputs.fingerprint }}"
          git push
