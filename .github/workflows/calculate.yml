name: Calculate PKG_MIRROR_HASH

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target OpenWrt version (e.g. openwrt-24.10)'
        required: false
        type: string

jobs:
  calculate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üßæ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìõ Extract PKG_NAME
        run: |
          PKG_NAME=$(grep -E '^PKG_NAME[:?]?=' Makefile | head -n1 | sed -E 's/PKG_NAME[:?]?= *//')
          echo "PKG_NAME=$PKG_NAME" >> "$GITHUB_ENV"

      - name: üì¶ Download OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          wget -q $SDK_URL
          tar -I zstd -xf $(basename $SDK_URL)
          SDK_DIR=$(tar -tf $(basename $SDK_URL) | awk -F/ 'NR==1 {print $1; exit}')

          echo "Ëß£ÂéãÂæóÂà∞ÁõÆÂΩï: $SDK_DIR"
          mv "$SDK_DIR" openwrt-sdk

      - name: üîó Link package into SDK
        run: |
          mkdir -p openwrt-sdk/package/custom
          rsync -a ./ openwrt-sdk/package/custom/${PKG_NAME}/ \
            --exclude 'openwrt-sdk' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'LICENSE' \
            --exclude 'README.md' \
            --exclude 'SECURITY.md'

      - name: üîç Run prepare to calculate hash
        run: |
          cd openwrt-sdk
          make defconfig
          make package/custom/${PKG_NAME}/prepare V=s || true | tee ../prepare.log

      - name: üìù Update PKG_MIRROR_HASH if needed
        run: |
          HASH=$(grep -A1 "Hash check failed" prepare.log | grep "Got:" | awk '{print $2}')
          if [ -n "$HASH" ]; then
            echo "‚úÖ Calculated PKG_MIRROR_HASH: $HASH"
            if grep -q "^PKG_MIRROR_HASH" Makefile; then
              sed -i "s|^PKG_MIRROR_HASH.*|PKG_MIRROR_HASH:=$HASH|" Makefile
            else
              echo "PKG_MIRROR_HASH:=$HASH" >> Makefile
            fi
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -am "Update PKG_MIRROR_HASH"
            git push
          else
            echo "‚ÑπÔ∏è No PKG_MIRROR_HASH changes."
          fi
