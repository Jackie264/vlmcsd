name: Check Upstream Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "Makefile"

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ§¾ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ” Check for updates
        id: check
        run: |
          UPSTREAM_URL="https://github.com/tfslabs/vlmcsd.git"
          API_URL="https://api.github.com/repos/tfslabs/vlmcsd/commits"
          
          CURRENT_VER=$(grep '^PKG_SOURCE_VERSION:=' Makefile | awk -F= '{print $2}' | tr -d '[:space:]')
          
          REMOTE_VER=$(git ls-remote $UPSTREAM_URL HEAD | awk '{print $1}')
          
          echo "Current: $CURRENT_VER"
          echo "Remote:  $REMOTE_VER"
          
          if [ -z "$REMOTE_VER" ]; then
            echo "âŒ Failed to get remote version."
            exit 1
          fi
          
          if [ "$CURRENT_VER" = "$REMOTE_VER" ]; then
            echo "âœ… Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸš€ New version found! Updating..."
          
          COMMIT_JSON=$(curl -s "${API_URL}/${REMOTE_VER}")
          NEW_DATE=$(echo "$COMMIT_JSON" | jq -r '.commit.committer.date' | cut -d'T' -f1)
          
          if [ -z "$NEW_DATE" ] || [ "$NEW_DATE" = "null" ]; then
             NEW_DATE=$(date +%Y-%m-%d)
          fi
          
          sed -i "s|^PKG_SOURCE_VERSION:=.*|PKG_SOURCE_VERSION:=$REMOTE_VER|" Makefile
          sed -i "s|^PKG_SOURCE_DATE:=.*|PKG_SOURCE_DATE:=$NEW_DATE|" Makefile
          
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_ver=$REMOTE_VER" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Commit and Push
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Makefile
          git commit -m "Auto-update vlmcsd to ${{ steps.check.outputs.new_ver }}"
          git push
